
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Projecting the surface &#8212; SMILE-TFA</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=a5519fdd" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css?v=fbdbc292" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Projection';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Results: Characterizing the Tangent Hypothesis" href="TangentHypothesis.html" />
    <link rel="prev" title="Characterizing the tangent hypothesis" href="TH.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="README.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/ESA_SMILE_missionlogo_patch.png" class="logo__image only-light" alt="SMILE-TFA - Home"/>
    <script>document.write(`<img src="_static/ESA_SMILE_missionlogo_patch.png" class="logo__image only-dark" alt="SMILE-TFA - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="README.html">
                    About this work
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Abstract.html">Locating the Earth’s magnetopause through X-ray imaging</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="Introduction.html">Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="Magnetopause.html">Earth’s Magnetopause</a></li>
<li class="toctree-l2"><a class="reference internal" href="Detecting.html">Detecting the magnetopause</a></li>
<li class="toctree-l2"><a class="reference internal" href="FittingMethods.html">Previous work: Fitting methods</a></li>
</ul><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Tangent Hypothesis</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="Chapter02.html">Extracting the magnetopause surface from the simulation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="LatepCube.html">LaTeP model: Emissivity cube</a></li>
<li class="toctree-l2"><a class="reference internal" href="ShueToSlice.html">Shue model fitted to slices</a></li>
<li class="toctree-l2"><a class="reference internal" href="MagSurface.html">Radial extraction of full magnetopause</a></li>
<li class="toctree-l2"><a class="reference internal" href="FittingModels.html">Fitting models to surface</a></li>
<li class="toctree-l2"><a class="reference internal" href="MHDsurface.html">Extracting the magnetopause from the MHD emissivity</a></li>
</ul><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="3DView.html">Extracting the maximum intensity curve from the image</a><ul>
<li class="toctree-l2"><a class="reference internal" href="MaxIntensityArc.html">Image processing</a></li>
</ul><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary>
</details></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="TH.html">Characterizing the tangent hypothesis</a><ul class="current">
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Projecting the surface</a></li>
<li class="toctree-l2"><a class="reference internal" href="TangentHypothesis.html">Results: Characterizing the Tangent Hypothesis</a></li>
</ul><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Tangent Fitting</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="Chapter03.html">Tangent Fitting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="TangentFitting.html">The method</a></li>
<li class="toctree-l2"><a class="reference internal" href="BenchmarkingTF.html">Benchmarking the fitting method</a></li>
<li class="toctree-l2"><a class="reference internal" href="Discussion.html">Discussion and Future developments</a></li>
</ul><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="dLaTeP.html">Dynamic LaTeP model</a></li>
<li class="toctree-l1"><a class="reference internal" href="Bibliography.html">Bibliography</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/notanobis/SMILE-TFA" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/notanobis/SMILE-TFA/issues/new?title=Issue%20on%20page%20%2FProjection.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/Projection.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>

</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Projecting the surface</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="projecting-the-surface">
<span id="numerical-surface-projection"></span><h1>Projecting the surface<a class="headerlink" href="#projecting-the-surface" title="Link to this heading">#</a></h1>
<p>Since we have extracted the numerical surface in spherical coordinates, we can also find the points that correspond to the tangent direction and project them into the FOV of the instrument. Let’s suppose that for a particular image, the satellite is located at the position <span class="math notranslate nohighlight">\(\vec{r}_{sat}=(x_{sat}, y_{sat}, z_{sat})\)</span> in the GSE system. The tangent points of the surface for this location will satisfy the condition:</p>
<div class="math notranslate nohighlight" id="equation-eq-tangent-eq">
<span class="eqno">(7)<a class="headerlink" href="#equation-eq-tangent-eq" title="Link to this equation">#</a></span>\[
\vec{n} \cdot (\vec{r}_{point}-\vec{r}_{sat} )= 0
\]</div>
<p>where <span class="math notranslate nohighlight">\(\vec{r}_{point}\)</span> is the position of each point of the numerical surface and <span class="math notranslate nohighlight">\(\vec{n}\)</span> is the normal vector of the surface for each point, in the GSE system. We can get <span class="math notranslate nohighlight">\(\vec{r}_{point}\)</span> by simply applying the transformation from the spherical system to the cartesian as defined in <a class="reference internal" href="Detecting.html#coordinate"><span class="std std-ref">Coordinate system</span></a>.</p>
<figure class="align-right" id="fig-schematic">
<a class="reference internal image-reference" href="_images/tangent_points.png"><img alt="_images/tangent_points.png" src="_images/tangent_points.png" style="width: 338.0px; height: 328.0px;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 14 </span><span class="caption-text">Tangent points in GSE.</span><a class="headerlink" href="#fig-schematic" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>To get the normal vectors, we calculate the gradient of the surface with respect to <span class="math notranslate nohighlight">\(\theta\)</span> and <span class="math notranslate nohighlight">\(\phi\)</span> and normalize the corresponding vectors. We can calculate the normals for each point through their cross product:</p>
<div class="math notranslate nohighlight">
\[
    \vec{n} = \frac{\partial \vec{r}}{\partial \theta} \times \frac{\partial \vec{r}}{\partial \phi}
\]</div>
<p>To get the tangent curve, we simply solve Equation <a class="reference internal" href="#equation-eq-tangent-eq">(7)</a> numerically, to get the points that satisfy it. In our case, we applied a simple mask with an arbitrary threshold of <span class="math notranslate nohighlight">\(0.05^\circ\)</span> tolerance, as a first approximate and fast solution.</p>
<p>This is defined in the function <code class="docutils literal notranslate"><span class="pre">tangent_points</span></code> of the <code class="docutils literal notranslate"><span class="pre">TangentFitting.py</span></code> script, where we find the normal vector for each point of the grid of the surface, calculate the vectors from the satellite to the grid points, and return the ones that have a dot product lower than the desired tolerance.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">tangent_points</span><span class="p">(</span><span class="n">R_numerical</span><span class="p">,</span> <span class="n">Theta</span><span class="p">,</span> <span class="n">Phi</span><span class="p">,</span> <span class="n">satellite_pos</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">R_numerical</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">Theta</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">R_numerical</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">Theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">Phi</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">R_numerical</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">Theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">Phi</span><span class="p">)</span>

    <span class="n">dx_dtheta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Theta</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">dy_dtheta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">Theta</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">dz_dtheta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">Theta</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">dx_dphi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Phi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dy_dphi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">Phi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dz_dphi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">Phi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">dtheta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">dx_dtheta</span><span class="p">,</span><span class="n">dy_dtheta</span><span class="p">,</span><span class="n">dz_dtheta</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dphi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">dx_dphi</span><span class="p">,</span> <span class="n">dy_dphi</span><span class="p">,</span> <span class="n">dz_dphi</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">normals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">dtheta</span><span class="p">,</span> <span class="n">dphi</span><span class="p">)</span>
    <span class="n">norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">normals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">normals</span> <span class="o">/=</span> <span class="n">norms</span>    

    <span class="n">x_sat</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">satellite_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y_sat</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">satellite_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">z_sat</span> <span class="o">=</span> <span class="n">z</span> <span class="o">-</span> <span class="n">satellite_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">vec_to_sat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">x_sat</span><span class="p">,</span> <span class="n">y_sat</span><span class="p">,</span> <span class="n">z_sat</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># shape: (n_theta, n_phi, 3)</span>
    <span class="n">norm_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vec_to_sat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">vec_to_sat_unit</span> <span class="o">=</span> <span class="n">vec_to_sat</span> <span class="o">/</span> <span class="n">norm_vec</span>  <span class="c1"># shape: (n_theta, n_phi, 3)</span>

    <span class="n">dot_product_num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">normals</span> <span class="o">*</span> <span class="n">vec_to_sat_unit</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># shape: (n_theta, n_phi)</span>
    <span class="c1"># dot_product_num = normals[..., 0] * x_sat + normals[..., 1] * y_sat + normals[..., 2] * z_sat</span>

    <span class="n">tolerance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>  <span class="c1"># e.g. 5 degrees grazing</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dot_product_num</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="n">tolerance</span><span class="p">)</span>
    <span class="c1"># mask = np.abs(dot_product_num) &lt; 0.1</span>
    <span class="n">x_sol</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">y_sol</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">z_sol</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">x_sol</span><span class="p">,</span> <span class="n">y_sol</span><span class="p">,</span> <span class="n">z_sol</span>
</pre></div>
</div>
</div>
</div>
<figure class="align-left" id="fig-tangent-points">
<a class="reference internal image-reference" href="_images/3D.png"><img alt="_images/3D.png" src="_images/3D.png" style="width: 391.2px; height: 273.59999999999997px;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 15 </span><span class="caption-text">Extraction of tangent point to satellite for a numerical surface.</span><a class="headerlink" href="#fig-tangent-points" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>The orientation of the satellite is described by three vectors, giving each base vector of the satellite coordinate system, expressed in the \ac{GSE} frame. To move from one system to another, it is sufficient to define the rotation matrix through these vectors and apply a translation according to the position of the satellite, meaning the origin of the satellite’s coordinate system. We construct the rotation matrix:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    R = \begin{bmatrix} | &amp; | &amp; | \\ \mathbf{e}_x^{sat} &amp; \mathbf{e}_y^{sat} &amp; \mathbf{e}_z^{sat} \\ | &amp; | &amp; | \end{bmatrix}
\end{split}\]</div>
<p>The relation between a vector in the GSE frame and the same vector in the satellite frame is:</p>
<div class="math notranslate nohighlight">
\[
    \vec{r}_{GSE} = R \cdot \vec{r}_{SF} + \vec{t}
\]</div>
<p>where <span class="math notranslate nohighlight">\(r_{SF}\)</span> is the vector of a point in the satellite frame and <span class="math notranslate nohighlight">\(\vec{t}\)</span> is the translation vector. Therefore, the transformation of a point in GSE to the satellite frame is performed by the following operation:</p>
<div class="math notranslate nohighlight">
\[
    \vec{v}_{sat} = R^\top \cdot (\vec{v}_{GSE} - \vec{t})
\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">GSE_to_Sat</span><span class="p">(</span><span class="n">x_GSE</span><span class="p">,</span> <span class="n">y_GSE</span><span class="p">,</span> <span class="n">z_GSE</span><span class="p">,</span> <span class="n">satellite_pos</span><span class="p">,</span> <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert GSE coordinates to satellite coordinates</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span><span class="p">])</span>
    <span class="n">GSE_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x_GSE</span><span class="p">,</span> <span class="n">y_GSE</span><span class="p">,</span> <span class="n">z_GSE</span><span class="p">])</span> <span class="o">-</span> <span class="n">satellite_pos</span>
    <span class="n">sat_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">GSE_vector</span><span class="o">.</span><span class="n">T</span> <span class="p">)</span>  <span class="c1"># Perform matrix multiplication</span>
    <span class="k">return</span> <span class="n">sat_vector</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sat_vector</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sat_vector</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>In order to project this in the SXI coordinates we need to compute the angle of each point from the z axis (boresight) along the x and y direction of the satellite frame:</p>
<div class="math notranslate nohighlight">
\[
    azimuth = \arctan{\frac{x}{z}}
\]</div>
<div class="math notranslate nohighlight">
\[
    elevation = \arctan{\frac{y}{z}}
\]</div>
<p>And limit this to the FOV of the imager, with <span class="math notranslate nohighlight">\(azimuth \in [-7.8,7.7]^\circ\)</span> and <span class="math notranslate nohighlight">\(elevation\in[-13.2,13.2]^\circ\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">Sat_to_SXI</span><span class="p">(</span><span class="n">x_sat</span><span class="p">,</span> <span class="n">y_sat</span><span class="p">,</span> <span class="n">z_sat</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert satellite coordinates to SXI FOV angles.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">azim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">x_sat</span><span class="p">,</span> <span class="n">z_sat</span><span class="p">)</span>  <span class="c1"># X-Z plane: up/down</span>
    <span class="n">elev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="o">-</span><span class="n">y_sat</span><span class="p">,</span> <span class="n">z_sat</span><span class="p">)</span>  <span class="c1"># Y-Z plane: left/right</span>

    <span class="c1"># FOV limits</span>
    <span class="n">azim_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">azim</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="o">-</span><span class="mf">7.8</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">azim</span><span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mf">7.7</span><span class="p">))</span>
    <span class="n">elev_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">elev</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="o">-</span><span class="mf">13.2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">elev</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mf">13.2</span><span class="p">))</span>
    <span class="c1"># Combine masks: keep values inside either azim or elev FOV</span>
    <span class="n">fov_mask</span> <span class="o">=</span> <span class="n">azim_mask</span> <span class="o">&amp;</span> <span class="n">elev_mask</span>  <span class="c1"># &lt;- this means inside both FOV limits</span>
    <span class="c1"># Apply mask</span>
    <span class="n">azim</span> <span class="o">=</span> <span class="n">azim</span><span class="p">[</span><span class="n">fov_mask</span><span class="p">]</span>
    <span class="n">elev</span> <span class="o">=</span> <span class="n">elev</span><span class="p">[</span><span class="n">fov_mask</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">azim</span><span class="p">,</span> <span class="n">elev</span>
</pre></div>
</div>
</div>
</div>
<p>We can also define a coordinate transformation from the SXI degree coordinates to the indexes of the image, by mapping these angles to grid indices <span class="math notranslate nohighlight">\(i_{\text{az}}\)</span> and <span class="math notranslate nohighlight">\(i_{\text{el}}\)</span>:</p>
<div class="math notranslate nohighlight">
\[
    i_{\text{az}} = \text{round} \left( \frac{\theta_{\text{az}} - \text{Az}{\min}}{\text{Az}{\max} - \text{Az}{\min}} \cdot (N{\text{az}} - 1) \right)
\]</div>
<div class="math notranslate nohighlight">
\[
    i_{\text{el}} = \text{round} \left( \frac{\theta_{\text{el}} - \text{El}{\min}}{\text{El}{\max} - \text{El}{\min}} \cdot (N{\text{el}} - 1) \right)
\]</div>
<p>where <span class="math notranslate nohighlight">\(N_{\text{az}}\)</span> and <span class="math notranslate nohighlight">\(N_{\text{el}}\)</span> are the number of azimuth and elevation grid points, respectively. To ensure the indices stay within valid bounds we also clip to the minimum of the grid:</p>
<div class="math notranslate nohighlight">
\[i_{\text{az}} = \min\left(\max\left(i_{\text{az}}, 0\right), N_{\text{az}} - 1\right)\]</div>
<div class="math notranslate nohighlight">
\[i_{\text{el}} = \min\left(\max\left(i_{\text{el}}, 0\right), N_{\text{el}} - 1\right)\]</div>
<p>The complete algorithm for the projection of the surface to the FOV is encapsulated in the funtion <code class="docutils literal notranslate"><span class="pre">surface_tangent_SXI</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">surface_tangent_SXI</span><span class="p">(</span><span class="n">R_numerical</span><span class="p">,</span><span class="n">Theta</span><span class="p">,</span><span class="n">Phi</span><span class="p">,</span> <span class="n">Az</span><span class="p">,</span> <span class="n">El</span><span class="p">,</span> <span class="n">satellite_pos</span><span class="p">,</span> <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span><span class="p">):</span>
    <span class="c1"># Solve the tangent equation in GSE</span>
    <span class="n">x_tangent_GSE</span><span class="p">,</span> <span class="n">y_tangent_GSE</span><span class="p">,</span> <span class="n">z_tangent_GSE</span> <span class="o">=</span> <span class="n">tangent_points</span><span class="p">(</span><span class="n">R_numerical</span><span class="p">,</span> <span class="n">Theta</span><span class="p">,</span> <span class="n">Phi</span><span class="p">,</span> <span class="n">satellite_pos</span><span class="p">)</span>
    <span class="c1"># Convert GSE coordinates to satellite coordinates</span>
    <span class="n">x_tangent_sat</span> <span class="p">,</span> <span class="n">y_tangent_sat</span><span class="p">,</span> <span class="n">z_tangent_sat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">x_tangent_GSE</span><span class="p">))),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">x_tangent_GSE</span><span class="p">))),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">x_tangent_GSE</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_tangent_GSE</span><span class="p">)):</span>
        <span class="n">x_tangent_sat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y_tangent_sat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">z_tangent_sat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">GSE_to_Sat</span><span class="p">(</span><span class="n">x_tangent_GSE</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y_tangent_GSE</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">z_tangent_GSE</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">satellite_pos</span><span class="p">,</span> <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span><span class="p">)</span>
    <span class="c1"># Convert satellite coordinates to SXI FOV angles</span>
    <span class="n">azim_SXI</span><span class="p">,</span> <span class="n">elev_SXI</span> <span class="o">=</span> <span class="n">Sat_to_SXI</span><span class="p">(</span><span class="n">x_tangent_sat</span><span class="p">,</span> <span class="n">y_tangent_sat</span><span class="p">,</span> <span class="n">z_tangent_sat</span><span class="p">)</span>
    <span class="c1"># interpolate the azimuth and elevation angles to the image grid</span>
    <span class="n">az_ind</span><span class="p">,</span> <span class="n">el_ind</span> <span class="o">=</span> <span class="n">interpolate</span><span class="p">(</span><span class="n">azim_SXI</span><span class="p">,</span> <span class="n">elev_SXI</span><span class="p">,</span> <span class="n">Az</span><span class="p">,</span> <span class="n">El</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">azim_SXI</span><span class="p">,</span> <span class="n">elev_SXI</span><span class="p">,</span> <span class="n">z_tangent_sat</span>
</pre></div>
</div>
</div>
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="TH.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Characterizing the tangent hypothesis</p>
      </div>
    </a>
    <a class="right-next"
       href="TangentHypothesis.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Results: Characterizing the Tangent Hypothesis</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Panayota Boskou
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>